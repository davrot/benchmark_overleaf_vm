services:
  overleafserver:
    image: docker.io/sharelatex/sharelatex:feature-authentication-ldap
    container_name: overleafserver
    hostname: overleafserver
    restart: always
    volumes:
    - ./data:/var/lib/overleaf
    - /var/run/docker.sock:/var/run/docker.sock
    ports:
    - 80

    environment:
      GIT_BRIDGE_ENABLED: false
      GIT_BRIDGE_HOST: git-bridge
      GIT_BRIDGE_PORT: 8000

      REDIS_HOST: overleafredis
      REDIS_PORT: 6379

      OVERLEAF_REDIS_HOST: overleafredis

      V1_HISTORY_URL: http://127.0.0.1:3100/api

      OVERLEAF_MONGO_URL: mongodb://overleafmongo/sharelatex

      OVERLEAF_APP_NAME: ${OVERLEAF_APP_NAME}

      OVERLEAF_BEHIND_PROXY: true
      OVERLEAF_SECURE_COOKIE: true

      OVERLEAF_SITE_URL: ${OVERLEAF_SITE_URL}
      OVERLEAF_NAV_TITLE: ${OVERLEAF_NAV_TITLE}

      OVERLEAF_ADMIN_EMAIL: ${OVERLEAF_ADMIN_EMAIL}
      OVERLEAF_EMAIL_FROM_ADDRESS: ${OVERLEAF_EMAIL_FROM_ADDRESS}
      OVERLEAF_EMAIL_SMTP_HOST: ${OVERLEAF_EMAIL_SMTP_HOST}
      OVERLEAF_EMAIL_SMTP_PORT: ${OVERLEAF_EMAIL_SMTP_PORT}
      OVERLEAF_EMAIL_SMTP_SECURE: ${OVERLEAF_EMAIL_SMTP_SECURE}
      OVERLEAF_EMAIL_SMTP_IGNORE_TLS: ${OVERLEAF_EMAIL_SMTP_IGNORE_TLS}
      OVERLEAF_EMAIL_SMTP_TLS_REJECT_UNAUTH: "false"
      OVERLEAF_EMAIL_SMTP_LOGGER: true
      OVERLEAF_CUSTOM_EMAIL_FOOTER: ${OVERLEAF_CUSTOM_EMAIL_FOOTER}

      EXTERNAL_AUTH: ldap
      OVERLEAF_LDAP_URL: "ldap://ldap:389"
      OVERLEAF_LDAP_SEARCH_BASE: "ou=people,dc=example,dc=com"
      OVERLEAF_LDAP_SEARCH_FILTER: "(|(uid={{username}})(mail={{username}}))"
      OVERLEAF_LDAP_BIND_DN: "cn=ldap_reader,dc=example,dc=com"
      OVERLEAF_LDAP_BIND_CREDENTIALS: "GoodNewsEveryone"
      OVERLEAF_LDAP_EMAIL_ATT: "mail"
      OVERLEAF_LDAP_FIRST_NAME_ATT: "givenName"
      OVERLEAF_LDAP_LAST_NAME_ATT: "sn"

      OVERLEAF_LDAP_SEARCH_ATTRIBUTES: '["uid", "sn", "givenName", "mail", "gidNumber", "employeeType"]'
      OVERLEAF_LDAP_UPDATE_USER_DETAILS_ON_LOGIN: "true"
      OVERLEAF_LDAP_IS_ADMIN_ATT: "employeeType"
      OVERLEAF_LDAP_IS_ADMIN_ATT_VALUE: "admin"

      OVERLEAF_LDAP_CONTACTS_FILTER: "(gidNumber={{userProperty}})"
      OVERLEAF_LDAP_CONTACTS_PROPERTY: "gidNumber"
      OVERLEAF_LDAP_CONTACTS_NON_LDAP_VALUE: "1000"

    networks:
      - overleaf-network

    healthcheck:
      test: bash -c "curl  -fsI --connect-timeout 10 http://localhost || exit 1"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s

networks:
  overleaf-network:
    external: true

